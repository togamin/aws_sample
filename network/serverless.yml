service: network
frameworkVersion: '3'

provider:
  name: aws
  runtime: python3.8
  stage: dev
  region: ap-northeast-1

resources:
  Resources:
    # ------------------------------------------------------------#
    #  VPC
    # ------------------------------------------------------------#
    VPC:
      Type: "AWS::EC2::VPC"
      Properties:
        CidrBlock: "10.1.0.0/16"
        Tags:
          - Key: Name
            Value: !Sub ${self:provider.stage}-vpc
    # ------------------------------------------------------------#
    #  InternetGateway
    # ------------------------------------------------------------#
    InternetGateway:
      Type: AWS::EC2::InternetGateway
      Properties:
        Tags:
          - Key: Name
            Value: !Sub ${self:provider.stage}-vpc-intenetgateway
    # ------------------------------------------------------------#
    #  InternetGatewayAttachment
    # ------------------------------------------------------------#
    InternetGatewayAttachment:
      Type: AWS::EC2::VPCGatewayAttachment
      Properties:
        InternetGatewayId: !Ref InternetGateway
        VpcId: !Ref VPC
    # ------------------------------------------------------------#
    #  Subnet
    # ------------------------------------------------------------#
    PublicSubnetA:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        CidrBlock: "10.1.0.0/24"
        AvailabilityZone: ap-northeast-1a
        Tags:
          - Key: Name
            Value: !Sub ${self:provider.stage}-vpc-subnetA

    PublicSubnetC:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        CidrBlock: "10.1.1.0/24"
        AvailabilityZone: ap-northeast-1c
        Tags:
          - Key: Name
            Value: !Sub ${self:provider.stage}-vpc-subnetC
    # ------------------------------------------------------------#
    #  RouteTable
    # ------------------------------------------------------------#
    PublicRouteTable:
      Type: AWS::EC2::RouteTable
      Properties:
        VpcId: !Ref VPC
        Tags:
          - Key: Name
            Value: !Sub ${self:provider.stage}-vpc-public-route-table
    # ------------------------------------------------------------#
    #  Route
    # ------------------------------------------------------------#
    PublicRoute:
      Type: AWS::EC2::Route
      Properties:
        RouteTableId: !Ref PublicRouteTable
        DestinationCidrBlock: "0.0.0.0/0"
        GatewayId: !Ref InternetGateway
    # ------------------------------------------------------------#
    #  SubnetRouteTableAssociation
    # ------------------------------------------------------------#
    PublicSubnetARouteTableAssociationA:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PublicRouteTable
        SubnetId: !Ref PublicSubnetA

    PublicSubnetARouteTableAssociationC:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PublicRouteTable
        SubnetId: !Ref PublicSubnetC
    # ------------------------------------------------------------#
    #  Flow Logs
    # ------------------------------------------------------------#
    VPCFlowLogs:
      Type: AWS::EC2::FlowLog
      DependsOn: VPCFlowLogsS3Bucket
      Properties:
        LogDestination: !Sub ${self:provider.stage}-flowlog-test-bucket/
        LogDestinationType: s3
        ResourceId: !Ref VPC
        ResourceType: "VPC"
        TrafficType: "ALL"
    VPCFlowLogsS3Bucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: !Sub ${self:provider.stage}-flowlog-test-bucket
    # ------------------------------------------------------------#
    #  SecurityGroup
    # ------------------------------------------------------------#
    SSHSecurityGroup:
      Type: AWS::EC2::SecurityGroup
        Properties:
          GroupDescription: "ssh"
            SecurityGroupIngress:
              -
                IpProtocol: tcp
                FromPort: 22
                ToPort: 22
                CidrIp: 0.0.0.0/0
            VpcId: !Ref VPC